<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DAUYS: –ü–∏–∫—Å–µ–ª—å–Ω—ã–µ –≤—ã–±–æ—Ä—ã ‚Äî 2022</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{ --tile:64px; }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    background:#0e0e10; color:#e7f3d8; font-family:"Press Start 2P",monospace;
    image-rendering:pixelated; overflow:hidden;
  }
  #ui{display:grid;grid-template-rows:auto 1fr auto;position:fixed;inset:0;padding:14px;gap:8px}
  header,footer{display:flex;align-items:center;justify-content:space-between;font-size:12px}

  /* –°—Ü–µ–Ω–∞ */
  #world{
    position:relative; margin:auto;
    width:calc(var(--tile)*14); /* 896px */
    height:calc(var(--tile)*9); /* 576px */
    border:3px solid #333; border-radius:16px; overflow:hidden;
    background:#1a1a1d center/cover no-repeat;
    transition:background-image .3s ease;
  }

  /* –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –∏ –∏—Ö –æ–±–ª–∞—á–∫–∞ */
  .candidate{
    position:absolute; top:100px; left:50%; transform:translateX(-50%);
    width:110px; height:110px; background:none; z-index:2;
  }
  #cand1{ left:35%; }
  #cand2{ left:65%; }

  .candidate img{
    width:100%; height:100%; object-fit:contain; image-rendering:pixelated;
    border:none; border-radius:0; background:transparent;
  }

  .speech{
    position:absolute; top:100%; left:50%; transform:translate(-50%, 10px);
    background:#111827; border:2px solid #000; border-radius:8px;
    padding:6px 8px; width:240px; text-align:center;
    font-size:10px; display:none; z-index:3;
  }

  /* –ò–≥—Ä–æ–∫ */
  #player{
    position:absolute; width:150px; height:150px; left:360px; top:380px; z-index:1;
    background:url('https://files.catbox.moe/6yemkc.png') center/contain no-repeat;
  }
  .tag{position:absolute;top:-14px;left:50%;transform:translateX(-50%);font-size:9px;background:#000a;padding:2px 6px;border-radius:6px}

  /* –•–∏—Ç–±–æ–∫—Å—ã */
  #desk, #ballotBox{ position:absolute; cursor:pointer; }

  /* –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π */
  #actions{ position:absolute; z-index:5; display:flex; gap:8px; }
  .hidden{ display:none !important; }
#controls{
  position:fixed;          /* –≤–º–µ—Å—Ç–æ absolute */
  bottom:20px; right:20px;
  display:flex; flex-direction:column; align-items:center; gap:4px;
  z-index:9999;            /* –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–≤–µ—Ä—Ö —Å—Ü–µ–Ω—ã */
  user-select:none;
}
#controls .ctrl{
  touch-action:none;        /* –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—å –ø–æ–¥ –ø–∞–ª—å—Ü–µ–º */
  -webkit-user-select:none; /* –Ω–µ –≤—ã–¥–µ–ª—è—Ç—å */
  user-select:none;
}
#controls .mid{ display:flex; gap:4px; } /* —á—Ç–æ–±—ã —Å—Ä–µ–¥–Ω–∏–π —Ä—è–¥ –±—ã–ª –≤ –ª–∏–Ω–∏—é */


  /* –¢–æ—Å—Ç */
  #toast{
    position:absolute; left:50%; bottom:20px; transform:translateX(-50%);
    background:#0b1320; border:2px solid #000; border-radius:8px; padding:6px 10px;
    font-size:10px; display:none; z-index:6;
  }

  button{font:inherit;padding:6px 10px;background:#15151b;border:2px solid #333;color:#e7f3d8;border-radius:10px;cursor:pointer;box-shadow:0 2px 0 #0008}
  button:active{transform:translateY(1px)}
  button[disabled]{opacity:.5; cursor:not-allowed}

  /* ===== –ú–æ–¥–∞–ª–∫–∞ –±—é–ª–ª–µ—Ç–µ–Ω—è ===== */
  #modal{
    position:fixed; inset:0; background:#000a; display:none; align-items:center; justify-content:center; z-index:10;
  }
  #modalCard{
    width:min(520px, 92vw); background:#0f172a; border:3px solid #000; border-radius:14px; padding:14px; box-shadow:0 6px 0 #0008;
  }
  #modal h3{ font-size:12px; margin-bottom:10px }
  .row{ display:flex; gap:10px; margin-bottom:10px }
  .row label{ font-size:10px; flex:1; display:flex; flex-direction:column; gap:6px }
  input, select{
    font:inherit; padding:8px; border:2px solid #333; border-radius:10px; background:#0b1022; color:#e7f3d8;
  }
  .modalActions{ display:flex; justify-content:flex-end; gap:8px; margin-top:6px }
  .error{ color:#fca5a5; font-size:10px; min-height:12px; }
</style>
</head>
<body>
<div id="ui">
  <header>
    <div class="title">–î–ê–£–´–° –ë–ï–†–£</div>
    <div id="roomLabel">–¥–∞—É—ã—Å –±–µ—Ä—É –±”©–ª–º–µ—Å—ñ ¬∑ 2022 –∂—ã–ª</div>
  </header>

 <main id="world">
  <!-- –∫–∞–Ω–¥–∏–¥–∞—Ç—ã -->
  <div id="cand1" class="candidate">
    <img src="" alt="">
    <div class="speech"></div>
  </div>
  <div id="cand2" class="candidate">
    <img src="" alt="">
    <div class="speech"></div>
  </div>

  <!-- –∑–æ–Ω—ã -->
  <div id="desk" title="–°—Ç–æ–ª"></div>
  <div id="ballotBox" title="–£—Ä–Ω–∞"></div>

  <!-- –∏–≥—Ä–æ–∫ -->
  <div id="player"><div class="tag">–í—ã</div></div>

  <!-- –¥–µ–π—Å—Ç–≤–∏—è -->
  <div id="actions" class="hidden">
    <button id="takeBtn" class="btn">üìÑ –ë—é–ª–ª–µ—Ç–µ–Ω—å –∞–ª—É</button>
    <button id="voteBtn" class="btn">üó≥Ô∏è –î–∞—É—ã—Å –±–µ—Ä—É</button>
  </div>

  <!-- —Ç–æ—Å—Ç -->
  <div id="toast">–°—ñ–∑ –¥–∞—É—ã—Å –±–µ—Ä–¥—ñ“£—ñ–∑!</div>
</main>

<!-- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –¢–ê–ß -->
<div id="controls">
  <button class="ctrl" data-dir="up">‚ñ≤</button>
  <div class="mid">
    <button class="ctrl" data-dir="left">‚óÄ</button>
    <button class="ctrl" data-dir="down">‚ñº</button>
    <button class="ctrl" data-dir="right">‚ñ∂</button>
  </div>
</div>


  <footer><div style="font-size:10px;opacity:.7">¬© –ê–ª–ª–∞–±–µ—Ä–≥–µ–Ω –ê—è—É–ª—ã–º</div></footer>
</div>

<!-- ===== MODAL: –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±—é–ª–ª–µ—Ç–µ–Ω—è ===== -->
<div id="modal">
  <form id="ballotForm" id="modalCard">
    <div id="modalCard">
      <h3>–î–∞—É—ã—Å –±–µ—Ä—É –ø–∞—Ä–∞“ì—ã–Ω —Ç–æ–ª—Ç—ã—Ä—É</h3>
      <div class="row">
        <label>–ê—Ç—ã
          <input id="firstName" type="text" placeholder="–ê—Ç—ã“£—ã–∑" required>
        </label>
        <label>–¢–µ–≥—ñ
          <input id="lastName" type="text" placeholder="–¢–µ–≥—ñ“£—ñ–∑" required>
        </label>
      </div>
      <div class="row">
        <label>–ñ–∞—Å—ã
          <input id="age" type="number" min="18" max="120" placeholder="18" required>
        </label>
        <label>–ö–∞–Ω–¥–∏–¥–∞—Ç
          <select id="candidateSelect" required></select>
        </label>
      </div>
      <div class="error" id="formError"></div>
      <div class="modalActions">
        <button type="button" id="cancelModal">–ê—Ä—Ç“õ–∞</button>
        <button type="submit" id="submitModal">–ë—é–ª–ª–µ—Ç–µ–Ω—å —Ç–æ–ª—Ç—ã—Ä—É</button>
      </div>
    </div>
  </form>
</div>

<script>
/* ---------- –î–ê–ù–ù–´–ï (2 –∫–∞–Ω–¥–∏–¥–∞—Ç–∞) ---------- */
const ROOM = {
  year: 2022,
  bg: "https://files.catbox.moe/n6digt.png",
  candidates: [
    {
      name: "“ö–∞—Å—ã–º-–ñ–æ–º–∞—Ä—Ç –¢–æ“õ–∞–µ–≤",
      avatar: "https://files.catbox.moe/reltng.png",
      phrases: [
        "”ò–¥—ñ–ª “õ–∞–∑–∞“õ—Å—Ç–∞–Ω - –±—ñ–∑–¥—ñ“£ –º–∞“õ—Å–∞—Ç—ã–º—ã–∑.", 
        "–ê—É—ã–ª–¥–∞—Ä –º–µ–Ω “õ–∞–ª–∞–ª–∞—Ä–¥—ã –¥–∞–º—ã—Ç—É.", 
        "–ñ–∞“£–∞ “õ–∞–∑–∞“õ—Å—Ç–∞–Ω!"
      ]
    },
    {
      name: "–ú–µ–∏—Ä–∞–º –ö–∞–∂—ã–∫–µ–Ω",               // ‚Üê –∑–∞–º–µ–Ω–∏
      avatar: "https://files.catbox.moe/963tgc.png",          // ‚Üê –∑–∞–º–µ–Ω–∏ –ø—É—Ç—ë–º –∫ PNG
      phrases: [
        "–ë–æ–ª–∞—à–∞“õ“õ–∞ “õ–∞–¥–∞–º!",
        "–ñ–∞“£–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–ª–∞—Ä.",
        "–î–∞–º—ã“ì–∞–Ω –µ–ª–¥–µ—Ä —Ç—ñ–∑—ñ–º—ñ–Ω–µ –µ–Ω–µ–º—ñ–∑!"
      ]
    }
  ],
  layout: {
    desk: { x: 700, y: 400, w: 120, h: 90 },
    box:  { x: 400, y: 340, w:  90, h:110 }
  },
  playerStart: { x:360, y:380 }
};

/* ---------- DOM ---------- */
const world      = document.getElementById('world');
const roomLabel  = document.getElementById('roomLabel');
const candEls    = [document.getElementById('cand1'), document.getElementById('cand2')];
const imgEls     = candEls.map(c => c.querySelector('img'));
const speechEls  = candEls.map(c => c.querySelector('.speech'));
const player     = document.getElementById('player');
const actions    = document.getElementById('actions');
const takeBtn    = document.getElementById('takeBtn');
const voteBtn    = document.getElementById('voteBtn');
const desk       = document.getElementById('desk');
const box        = document.getElementById('ballotBox');
const toast      = document.getElementById('toast');

/* Modal DOM */
const modal      = document.getElementById('modal');
const ballotForm = document.getElementById('ballotForm');
const firstName  = document.getElementById('firstName');
const lastName   = document.getElementById('lastName');
const ageInput   = document.getElementById('age');
const selectCand = document.getElementById('candidateSelect');
const formError  = document.getElementById('formError');
const cancelModal= document.getElementById('cancelModal');

/* ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---------- */
let keys={}, px=ROOM.playerStart.x, py=ROOM.playerStart.y, speed=3.2, facing='front';
let hasPaper=false;             // –±—é–ª–ª–µ—Ç–µ–Ω—å –∑–∞–ø–æ–ª–Ω–µ–Ω –∏ –Ω–∞ —Ä—É–∫–∞—Ö
let voter=null;                 // {firstName,lastName,age,candidateIdx}
let bubbleTimers=[null,null], hideTimers=[null,null];

/* ---------- –î–≤–∏–∂–µ–Ω–∏–µ ---------- */
addEventListener('keydown', e=>keys[e.key]=true);
addEventListener('keyup',   e=>keys[e.key]=false);
// === –í–ò–†–¢-–°–¢–†–ï–õ–ö–ò (—Ç–∞—á/–º—ã—à—å) ===
const dirKey = { up:'ArrowUp', down:'ArrowDown', left:'ArrowLeft', right:'ArrowRight' };

document.querySelectorAll('#controls .ctrl').forEach(btn=>{
  const key = dirKey[btn.dataset.dir];
  if(!key) return;

  const press   = (e)=>{ e.preventDefault(); keys[key] = true;  };
  const release = (e)=>{ e.preventDefault(); keys[key] = false; };

  // Pointer-—Å–æ–±—ã—Ç–∏—è –ø–æ–∫—Ä—ã–≤–∞—é—Ç –∏ —Ç–∞—á, –∏ –º—ã—à—å
  btn.addEventListener('pointerdown', press,   {passive:false});
  btn.addEventListener('pointerup',   release, {passive:false});
  btn.addEventListener('pointerleave',release, {passive:false});
  btn.addEventListener('pointercancel',release,{passive:false});
});

// –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –æ—Ç–ø—É—Å–∫–∞–µ–º –≤—Å—ë –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã / –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
window.addEventListener('pointerup',   ()=>{ Object.keys(dirKey).forEach(d=>keys[dirKey[d]]=false); });
window.addEventListener('blur',        ()=>{ Object.keys(dirKey).forEach(d=>keys[dirKey[d]]=false); });
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden) Object.keys(dirKey).forEach(d=>keys[dirKey[d]]=false);
});
function move(){
  const r=world.getBoundingClientRect();
  let moved=false;
  if(keys['ArrowLeft']||keys['a']) { px-=speed; facing='left'; moved=true; }
  if(keys['ArrowRight']||keys['d']){ px+=speed; facing='right'; moved=true; }
  if(keys['ArrowUp']||keys['w'])   { py-=speed; facing='back'; moved=true; }
  if(keys['ArrowDown']||keys['s']) { py+=speed; facing='front'; moved=true; }

  px=Math.max(10, Math.min(r.width-160, px));
  py=Math.max(10, Math.min(r.height-160, py));

  player.style.left=px+'px';
  player.style.top =py+'px';

  if(moved) updateSprite();
  checkProximity();
  requestAnimationFrame(move);
}
requestAnimationFrame(move);

function updateSprite(){
  const map={
    front:"https://files.catbox.moe/6yemkc.png",
    back :"https://files.catbox.moe/vmul5g.png",
    left :"https://files.catbox.moe/ahsbh6.png",
    right:"https://files.catbox.moe/lo8v7p.png"
  };
  player.style.backgroundImage = `url(${map[facing]})`;
}

/* ---------- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ ---------- */
function rect(el){ return el.getBoundingClientRect() }
function near(ax,ay,bx,by,dist){ return Math.hypot(ax-bx, ay-by) < dist }

function checkProximity(){
  const pr = rect(player), wr = rect(world);
  const pw = pr.left - wr.left + pr.width/2, ph = pr.top - wr.top + pr.height/2;

  const dr = rect(desk), dw = dr.left - wr.left + dr.width/2, dh = dr.top - wr.top + dr.height/2;
  const br = rect(box),  bw = br.left - wr.left + br.width/2, bh = br.top - wr.top + br.height/2;

  let shown=false;

  // —Å—Ç–æ–ª
  if(near(pw,ph,dw,dh,90)){
    actions.classList.remove('hidden');
    actions.style.left = (dw - 80) + 'px';
    actions.style.top  = (dr.top - wr.top - 30) + 'px';
    takeBtn.style.display='inline-block';
    shown=true;
  } else takeBtn.style.display='none';

  // —É—Ä–Ω–∞
  if(hasPaper && near(pw,ph,bw,bh,90)){
    actions.classList.remove('hidden');
    actions.style.left = (bw - 80) + 'px';
    actions.style.top  = (br.top - wr.top - 30) + 'px';
    voteBtn.style.display='inline-block';
    shown=true;
  } else voteBtn.style.display='none';

  if(!shown) actions.classList.add('hidden');
}

/* === –ú–æ–¥–∞–ª–∫–∞ –±—é–ª–ª–µ—Ç–µ–Ω—è === */
function openModal(){
  // –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏
  selectCand.innerHTML = ROOM.candidates
    .map((c,i)=>`<option value="${i}">${c.name}</option>`).join('');
  formError.textContent = '';
  modal.style.display='flex';
}
function closeModal(){ modal.style.display='none'; }

takeBtn.onclick = () => {
  openModal(); // —Ç–µ–ø–µ—Ä—å ¬´–í–∑—è—Ç—å –±—é–ª–ª–µ—Ç–µ–Ω—å¬ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É
};

cancelModal.onclick = closeModal;

ballotForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const fn = firstName.value.trim();
  const ln = lastName.value.trim();
  const age= Number(ageInput.value);
  const idx= Number(selectCand.value);

  if(!fn || !ln || !age || age<18){
    formError.textContent = '–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è. –í–æ–∑—Ä–∞—Å—Ç ‚Äî –æ—Ç 18.';
    return;
  }

  voter = { firstName: fn, lastName: ln, age, candidateIdx: idx };
  hasPaper = true;

  // –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
  takeBtn.textContent = 'üìÑ –ë—é–ª–ª–µ—Ç–µ–Ω—å –¥–∞–π—ã–Ω.';
  takeBtn.disabled = true;
  closeModal();

  toast.textContent = '–ë—é–ª–ª–µ—Ç–µ–Ω—å —Ç–æ–ª—Ç—ã—Ä—ã–ª–¥—ã. “ö–æ—Ä–∞–ø—à–∞“ì–∞ –±–∞—Ä—ã“£—ã–∑!';
  toast.style.display='block';
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> toast.style.display='none', 1500);
});

/* –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ */
voteBtn.onclick=()=>{ 
  if(!hasPaper || !voter) return;
  hasPaper=false; 
  voteBtn.style.display='none';

  const chosen = ROOM.candidates[voter.candidateIdx]?.name || '‚Äî';
  toast.textContent = `–°—ñ–∑: ${chosen} ‚Äî –¥–∞—É—ã—Å –±–µ—Ä–¥—ñ“£—ñ–∑!`;
  toast.style.display='block';
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> toast.style.display='none', 1800);

  // —Ä–∞–∑—Ä–µ—à–∏–º –≤–∑—è—Ç—å –Ω–æ–≤—ã–π –±—é–ª–ª–µ—Ç–µ–Ω—å (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
  takeBtn.textContent = 'üìÑ –ë—é–ª–ª–µ—Ç–µ–Ω—å –∞–ª—É';
  takeBtn.disabled = false;
};

/* ---------- –†–µ–ø–ª–∏–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ---------- */
function speakLoop(idx, phrases){
  clearInterval(bubbleTimers[idx]);
  const bubble = speechEls[idx];

  const say = () => {
    if(!phrases || !phrases.length){ bubble.style.display='none'; return; }
    const t = phrases[Math.floor(Math.random()*phrases.length)];
    bubble.textContent = t;
    bubble.style.display = 'block';
    clearTimeout(hideTimers[idx]);
    hideTimers[idx] = setTimeout(()=> bubble.style.display='none', 8000);
  };

  say();
  bubbleTimers[idx] = setInterval(say, 11000 + Math.random()*4000);
}

/* ---------- –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É –∏ —Ñ–æ–Ω ---------- */
function applyLayout(L){
  Object.assign(desk.style, { left:L.desk.x+'px', top:L.desk.y+'px', width:L.desk.w+'px', height:L.desk.h+'px' });
  Object.assign(box.style,  { left:L.box.x +'px', top:L.box.y +'px', width:L.box.w +'px', height:L.box.h +'px' });
}

/* ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---------- */
function init(){
  world.style.backgroundImage = `url(${ROOM.bg})`;
  roomLabel.textContent = `–î–∞—É—ã—Å –±–µ—Ä—É –±”©–ª–º–µ—Å—ñ ¬∑ ${ROOM.year}`;

  ROOM.candidates.forEach((c, i)=>{
    imgEls[i].src = c.avatar || '';
    speakLoop(i, c.phrases || []);
  });

  applyLayout(ROOM.layout);

  player.style.left = ROOM.playerStart.x+'px';
  player.style.top  = ROOM.playerStart.y+'px';
}
init();
</script>
</body>
</html>
